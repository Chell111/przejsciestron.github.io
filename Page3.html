<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Vote + Comment (DevTools-only Results)</title>
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --accent:#2563eb; --muted:#6b7280; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:600px;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(15,23,42,0.06)}
    h1{margin:0 0 8px;font-size:1.2rem}
    p.lead{margin:0 0 12px;color:var(--muted)}
    form{display:flex;flex-direction:column;gap:10px}
    .options{display:flex;flex-direction:column;gap:8px}
    .option{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:8px;border:1px solid #f0f2f7}
    .option input[type="radio"]{margin-top:4px}
    .comment{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9f2;font-size:0.95rem;resize:vertical;min-height:70px}
    .row{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:#eef5ff;color:var(--accent);border:1px solid rgba(37,99,235,0.08)}
    .results{margin-top:14px;border-top:1px dashed #eef2f8;padding-top:12px}
    .result-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
    .small{font-size:0.9rem;padding:8px 10px}
    .meta{color:var(--muted);font-size:0.9rem}
    pre{background:#0b1220;color:#dbeafe;padding:10px;border-radius:6px;overflow:auto;font-size:0.85rem}
    .dev-hint{
      margin-top:12px;
      padding:10px;
      border-radius:8px;
      background:#fff8dc;
      border:1px solid #ffe6a1;
      color:#665200;
      font-size:.95rem;
    }
    @media (max-width:520px){ .card{padding:14px} }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="title">
      <h1 id="title">Quick Vote</h1>
      <p class="lead">Choose one option and (optionally) add a short comment. Votes are saved locally in your browser — results are visible only when your browser's developer tools are open.</p>

      <form id="pollForm" autocomplete="off">
        <div class="options" id="optionsList" role="radiogroup" aria-label="Voting options">
          <!-- Options are rendered by JavaScript -->
        </div>

        <label for="comment" class="meta">Comment about your choice (optional)</label>
        <textarea id="comment" class="comment" name="comment" placeholder="Add a short note..."></textarea>

        <div class="row" style="margin-top:6px">
          <button type="submit">Vote</button>
          <button id="exportBtn" type="button" class="secondary small">Export JSON</button>
          <button id="clearBtn" type="button" class="secondary small">Clear all</button>
        </div>
      </form>

      <!-- Hint shown on page when DevTools are closed -->
      <div id="devHint" class="dev-hint" role="status" aria-live="polite" style="display:none">
        Developer tools are closed — open DevTools (F12 / Ctrl+Shift+I / Cmd+Opt+I) to view results.
      </div>

      <section id="results" class="results" aria-live="polite" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Results</strong>
          <span class="meta" id="totalVotes">0 votes</span>
        </div>
        <div id="resultsList" style="margin-top:8px"></div>

        <div style="margin-top:10px">
          <label class="meta">Latest comments</label>
          <div id="commentsList" style="margin-top:6px"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      // Simple vote + comment widget with "DevTools-only results"
      const STORAGE_KEY = 'simple.vote.v1';

      // Customize options here:
      const OPTIONS = [
        { id: 'opt-a', label: 'Option A' },
        { id: 'opt-b', label: 'Option B' },
        { id: 'opt-c', label: 'Option C' }
      ];

      // DOM
      const optionsList = document.getElementById('optionsList');
      const form = document.getElementById('pollForm');
      const commentEl = document.getElementById('comment');
      const resultsList = document.getElementById('resultsList');
      const commentsList = document.getElementById('commentsList');
      const totalVotesEl = document.getElementById('totalVotes');
      const exportBtn = document.getElementById('exportBtn');
      const clearBtn = document.getElementById('clearBtn');
      const resultsSection = document.getElementById('results');
      const devHint = document.getElementById('devHint');

      // Storage helpers
      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : { votes: [] };
        } catch (e) {
          console.error('load error', e);
          return { votes: [] };
        }
      }
      function save(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      // Render radio options
      function renderOptions() {
        optionsList.innerHTML = '';
        for (const opt of OPTIONS) {
          const wrap = document.createElement('label');
          wrap.className = 'option';
          wrap.innerHTML = `
            <input type="radio" name="choice" value="${escapeHtml(opt.id)}" />
            <div>
              <div style="font-weight:600">${escapeHtml(opt.label)}</div>
            </div>
          `;
          optionsList.appendChild(wrap);
        }
      }

      // Utility: escape HTML for text content
      function escapeHtml(s) {
        return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      // Add a vote
      function addVote(choiceId, comment) {
        const state = load();
        state.votes.unshift({ choice: choiceId, comment: comment || '', ts: Date.now() });
        save(state);
        // If devtools are open, immediately refresh visible results
        if (isDevToolsOpen) renderResults();
      }

      // Compute counts and latest comments
      function computeSummary() {
        const state = load();
        const counts = {};
        const latestComments = {};
        for (const o of OPTIONS) { counts[o.id] = 0; latestComments[o.id] = []; }
        for (const v of state.votes) {
          if (!counts.hasOwnProperty(v.choice)) continue;
          counts[v.choice]++;
          if (v.comment && v.comment.trim()) {
            latestComments[v.choice].push({ text: v.comment.trim(), ts: v.ts });
          }
        }
        return { counts, latestComments, total: state.votes.length };
      }

      // Render results area
      function renderResults() {
        const summary = computeSummary();
        resultsList.innerHTML = '';
        commentsList.innerHTML = '';
        totalVotesEl.textContent = summary.total + (summary.total === 1 ? ' vote' : ' votes');

        for (const opt of OPTIONS) {
          const row = document.createElement('div');
          row.className = 'result-row';
          row.innerHTML = `<div>${escapeHtml(opt.label)}</div><div class="meta">${summary.counts[opt.id]}</div>`;
          resultsList.appendChild(row);
        }

        for (const opt of OPTIONS) {
          const header = document.createElement('div');
          header.style.marginTop = '8px';
          header.innerHTML = `<strong>${escapeHtml(opt.label)}</strong>`;
          commentsList.appendChild(header);

          const items = summary.latestComments[opt.id].slice(0,5);
          if (items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'meta';
            empty.textContent = '— no comments';
            commentsList.appendChild(empty);
          } else {
            for (const it of items) {
              const d = new Date(it.ts);
              const div = document.createElement('div');
              div.style.marginTop = '6px';
              div.innerHTML = `<div style="font-size:.95rem">${escapeHtml(it.text)}</div><div class="meta" style="font-size:.8rem">${d.toLocaleString()}</div>`;
              commentsList.appendChild(div);
            }
          }
        }
      }

      // Export to file
      function exportJSON() {
        const data = load();
        if (!data.votes || data.votes.length === 0) return alert('No votes to export.');
        const blob = new Blob([JSON.stringify(data.votes, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'votes.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Clear storage
      function clearAll() {
        if (!confirm('Clear all saved votes? This cannot be undone.')) return;
        localStorage.removeItem(STORAGE_KEY);
        renderResults();
      }

      // Form submit handler
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const choice = formData.get('choice');
        const comment = (commentEl.value || '').trim();
        if (!choice) {
          return alert('Please select an option before voting.');
        }
        addVote(choice, comment);
        form.reset();
        commentEl.value = '';
        commentEl.focus();
      });

      exportBtn.addEventListener('click', exportJSON);
      clearBtn.addEventListener('click', clearAll);

      // --- DevTools detection logic ---
      // We'll use multiple heuristics to detect if DevTools is open:
      //  1) Difference between outer and inner window dimensions (common sign)
      //  2) Console getter trick: console will read properties when DevTools console is open
      // Combined checks are poll-based and update UI on change.
      let isDevToolsOpen = false;
      function setDevToolsState(open) {
        if (open === isDevToolsOpen) return;
        isDevToolsOpen = !!open;
        // Show/hide the visible results section and hint
        resultsSection.style.display = isDevToolsOpen ? '' : 'none';
        devHint.style.display = isDevToolsOpen ? 'none' : '';
        if (isDevToolsOpen) {
          renderResults();
          // also print a handy summary to the console for quick inspection
          try {
            const data = load().votes || [];
            console.groupCollapsed('Votes (most recent first) — printed because DevTools is open');
            console.log('Total votes:', data.length);
            console.table(data.slice(0, 50).map(v => ({ choice: v.choice, comment: v.comment, time: new Date(v.ts).toLocaleString() })));
            console.groupEnd();
          } catch (e) { /* ignore */ }
        }
      }

      // Heuristic A: size difference
      function sizeDiffOpen() {
        const threshold = 160; // pixels, typical threshold used in many libs
        try {
          return (window.outerWidth - window.innerWidth) > threshold || (window.outerHeight - window.innerHeight) > threshold;
        } catch (e) {
          return false;
        }
      }

      // Heuristic B: console getter trick (fires when console inspects the object)
      let consoleGetterFired = false;
      function setupConsoleDetector() {
        consoleGetterFired = false;
        try {
          const img = new Image();
          Object.defineProperty(img, 'id', {
            get: function () {
              consoleGetterFired = true;
              // return something harmless
              return 'devtools-detected';
            }
          });
          // When DevTools console is open, logging this object usually triggers the getter
          console.log('%c', img);
        } catch (e) {
          // ignore any errors in exotic environments
          consoleGetterFired = false;
        }
      }

      // Polling loop
      let lastCheck = 0;
      function checkDevTools() {
        // Run console detector on each check so getter runs if console open
        setupConsoleDetector();
        const sizeOpen = sizeDiffOpen();
        const open = sizeOpen || consoleGetterFired;
        setDevToolsState(open);
        lastCheck = Date.now();
      }

      // Initial render state (hide results until detection runs)
      resultsSection.style.display = 'none';
      devHint.style.display = '';

      // Start polling every 700ms
      checkDevTools();
      const interval = setInterval(checkDevTools, 700);

      // also check on resize (quick response when DevTools opens docked)
      window.addEventListener('resize', checkDevTools);

      // cleanup if page is unloaded
      window.addEventListener('beforeunload', () => {
        clearInterval(interval);
      });

      // Init UI
      renderOptions();
      // don't render results until DevTools is detected (they're intentionally hidden)
    })();
  </script>
</body>
</html>
